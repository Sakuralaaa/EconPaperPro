# EconPaper Pro ä»£ç å®¡æŸ¥æŠ¥å‘Š

## å®¡æŸ¥æ¦‚è¿°

**å®¡æŸ¥æ—¥æœŸ**: 2026-01-08
**æœ€åæ›´æ–°**: 2026-01-08 (ä¿®å¤çŠ¶æ€æ›´æ–°)
**å®¡æŸ¥èŒƒå›´**: æ ¸å¿ƒæ¨¡å— `ui/native_app.py`, `ui/components.py`, `core/history.py`, `agents/optimizer.py`, `agents/revision.py`, `utils/diff.py`
**å®¡æŸ¥ç›®çš„**: è¯†åˆ«æ½œåœ¨çš„ bugã€é€»è¾‘é”™è¯¯å’Œä»£ç è´¨é‡é—®é¢˜

---

## ä¿®å¤çŠ¶æ€æ±‡æ€»

| é—®é¢˜ | ä¼˜å…ˆçº§ | çŠ¶æ€ | ä¿®å¤ä½ç½® |
|------|--------|------|----------|
| #1 å˜é‡å¼•ç”¨é¡ºåºé”™è¯¯ | P0 | âœ… **å·²ä¿®å¤** | native_app.py:884-930 |
| #2 Lambda é—­åŒ…é™·é˜± | P0 | âœ… **å·²ä¿®å¤** | native_app.py:3193, 3305, 3400-3403, 3475 |
| #3 å±æ€§è®¿é—®æ—¶åºé—®é¢˜ | P1 | âœ… **å·²ä¿®å¤** | native_app.py:1748 |
| #4 pack(after=...) å‚æ•°é—®é¢˜ | P2 | âœ… **å·²ä¿®å¤** | native_app.py:977-989 |
| #5 ç»„ä»¶é”€æ¯åè°ƒç”¨é£é™© | P1 | âœ… **å·²ä¿®å¤** | components.py:880 |
| #6 è£¸ except è¯­å¥ | P2 | âœ… **å·²ä¿®å¤** | native_app.py:1650-1653 |
| #7 ç±»å˜é‡å…±äº«çŠ¶æ€ | P3 | ğŸ’¡ è®¾è®¡å»ºè®® | - |
| #8 å¼‚å¸¸å¤„ç†ä»…æ‰“å°ä¸è®°å½• | P3 | âœ… **å·²ä¿®å¤** | history.py:1-15, 112-159 |
| #9 Pylance è­¦å‘Š | P3 | âœ… **å·²ä¿®å¤** | native_app.py:44-48 |
| #10 UI ç»„ä»¶é‡å»ºå¯¼è‡´è¾“å…¥ä¸¢å¤± | P2 | âœ… **å·²ä¿®å¤** | native_app.py:2499-2645 |

---

## ğŸ”´ ä¸¥é‡é—®é¢˜ (Critical)

### 1. âœ… å˜é‡å¼•ç”¨é¡ºåºé”™è¯¯ - å·²ä¿®å¤

**æ–‡ä»¶**: [`native_app.py`](ui/native_app.py:884)
**çŠ¶æ€**: âœ… **å·²ä¿®å¤**

**åŸé—®é¢˜æè¿°**: åœ¨ `_create_optimize_page` æ–¹æ³•ä¸­ï¼Œæ¨¡æ¿é€‰æ‹©å™¨å¼•ç”¨äº†å°šæœªåˆ›å»ºçš„ `self.opt_input_comp`ã€‚

**ä¿®å¤æ–¹æ¡ˆ**: ä»£ç å·²é‡æ–°ç»„ç»‡ï¼Œ`opt_input_comp` ç°åœ¨åœ¨ç¬¬ 925 è¡Œåˆ›å»ºï¼Œæ¨¡æ¿é€‰æ‹©å™¨åœ¨ç¬¬ 930 è¡Œåˆ›å»ºï¼Œé¡ºåºæ­£ç¡®ï¼š

```python
# ç¬¬ 925 è¡Œ - å˜é‡å…ˆåˆ›å»º
self.opt_input_comp = TextInputWithCount(right_panel, height=10, placeholder="åœ¨æ­¤ç²˜è´´è®ºæ–‡å†…å®¹...", max_chars=15000)

# ç¬¬ 930 è¡Œ - æ¨¡æ¿é€‰æ‹©å™¨ååˆ›å»ºï¼Œå¯ä»¥å®‰å…¨å¼•ç”¨
self._create_template_selector(config_inner, "optimize", self.opt_input_comp)
```

---

### 2. âœ… Lambda é—­åŒ…é™·é˜± - å·²ä¿®å¤

**æ–‡ä»¶**: [`native_app.py`](ui/native_app.py:3193)
**çŠ¶æ€**: âœ… **å·²ä¿®å¤**

**åŸé—®é¢˜æè¿°**: åœ¨å¾ªç¯ä¸­ä½¿ç”¨ lambda æ—¶ï¼Œå˜é‡æ•è·çš„æ˜¯å¼•ç”¨è€Œéå€¼ï¼Œå¯¼è‡´æ‰€æœ‰è¿›åº¦æ›´æ–°éƒ½æ˜¾ç¤ºæœ€åä¸€æ¬¡å¾ªç¯çš„å€¼ã€‚

**ä¿®å¤æ–¹æ¡ˆ**: æ‰€æœ‰å—å½±å“ä½ç½®å‡å·²ä½¿ç”¨é»˜è®¤å‚æ•°æ•è·å½“å‰å€¼ï¼š

```python
# ä¿®å¤åçš„å†™æ³• - ä½¿ç”¨é»˜è®¤å‚æ•°æ•è·å¾ªç¯å˜é‡
self._safe_update(lambda idx=i, name=fname, total=total_files: self.precise_progress["diagnose"].update(idx, f"æ­£åœ¨å¤„ç† ({idx}/{total}): {name}"))
```

**å·²ä¿®å¤ä½ç½®**:
- ç¬¬ 3193 è¡Œ: `_run_diagnose` æ‰¹é‡è¯Šæ–­ âœ…
- ç¬¬ 3305 è¡Œ: `_run_optimize` æ‰¹é‡ä¼˜åŒ– âœ…
- ç¬¬ 3400-3403 è¡Œ: `_run_optimize_stream` æµå¼ä¼˜åŒ– âœ…
- ç¬¬ 3475 è¡Œ: `_run_dedup` æ‰¹é‡é™é‡ âœ…

---

## ğŸŸ  ä¸­ç­‰é—®é¢˜ (Medium)

### 3. âœ… å±æ€§è®¿é—®æ—¶åºé—®é¢˜ - å·²ä¿®å¤

**æ–‡ä»¶**: [`native_app.py`](ui/native_app.py:1748)
**çŠ¶æ€**: âœ… **å·²ä¿®å¤**

**åŸé—®é¢˜æè¿°**: `_load_ui_preferences` è®¿é—®å¯èƒ½å°šæœªåˆ›å»ºçš„ `self.dark_mode_var`ã€‚

**ä¿®å¤æ–¹æ¡ˆ**: å·²æ·»åŠ  `hasattr` æ£€æŸ¥ï¼ˆç¬¬ 1748 è¡Œï¼‰ï¼š

```python
is_dark = self.history.get_preference("dark_mode", False)
if hasattr(self, 'dark_mode_var'):  # å®‰å…¨æ£€æŸ¥
    self.dark_mode_var.set(is_dark)
```

---

### 4. âœ… pack(after=...) å‚æ•°ä½¿ç”¨é—®é¢˜ - å·²ä¿®å¤

**æ–‡ä»¶**: [`native_app.py`](ui/native_app.py:977-989)
**çŠ¶æ€**: âœ… **å·²ä¿®å¤**

**åŸé—®é¢˜æè¿°**: `pack(after=...)` å‚æ•°å¯èƒ½åœ¨æŸäº› Tkinter ç‰ˆæœ¬ä¸‹ä¸æ­£ç¡®å·¥ä½œã€‚

**ä¿®å¤æ–¹æ¡ˆ**: å·²ä½¿ç”¨æ›¿ä»£æ–¹æ³•ï¼Œé€šè¿‡ `lift()` å’Œæ˜¾å¼ `pack` é¡ºåºæ§åˆ¶å¸ƒå±€ï¼š

```python
if self.opt_context_visible.get():
    # ä¿®å¤: é¿å…ä½¿ç”¨ pack(after=...) å‚æ•°
    self.opt_context_frame.pack(fill=tk.X, pady=(0, 10))
    try:
        self.opt_context_frame.lift()
    except Exception:
        pass
    self.context_toggle_btn.config(text="[ æŠ˜å  - ]")
```

---

### 5. âœ… çº¿ç¨‹ä¸­ç»„ä»¶é”€æ¯åçš„è°ƒç”¨é£é™© - å·²ä¿®å¤

**æ–‡ä»¶**: [`components.py`](ui/components.py:880)
**çŠ¶æ€**: âœ… **å·²ä¿®å¤**

**åŸé—®é¢˜æè¿°**: åå°çº¿ç¨‹ä¸­ `self.after()` è°ƒç”¨å¯èƒ½åœ¨ç»„ä»¶é”€æ¯åæ‰§è¡Œã€‚

**ä¿®å¤æ–¹æ¡ˆ**: å·²åœ¨æ‰€æœ‰ UI æ›´æ–°è°ƒç”¨å‰æ·»åŠ  `winfo_exists()` æ£€æŸ¥ï¼š

```python
def stream_thread():
    for chunk in generator:
        # ä¿®å¤: æ·»åŠ ç»„ä»¶å­˜åœ¨æ€§æ£€æŸ¥é˜²æ­¢é”€æ¯åè°ƒç”¨
        if self.winfo_exists():
            self.after(0, lambda c=chunk: self.append_chunk(c))
        else:
            break  # ç»„ä»¶å·²é”€æ¯ï¼Œåœæ­¢å¤„ç†
    
    # å®Œæˆ - ä¿®å¤: æ·»åŠ ç»„ä»¶å­˜åœ¨æ€§æ£€æŸ¥
    if self.winfo_exists():
        self.after(0, lambda: self.end_streaming(True))
```

---

### 6. âœ… è£¸ except è¯­å¥ - å·²ä¿®å¤

**æ–‡ä»¶**: [`native_app.py`](ui/native_app.py:1650-1653)
**çŠ¶æ€**: âœ… **å·²ä¿®å¤**

**åŸé—®é¢˜æè¿°**: ä½¿ç”¨è£¸ `except:` ä¼šæ•è·æ‰€æœ‰å¼‚å¸¸ã€‚

**ä¿®å¤æ–¹æ¡ˆ**: å·²æ˜ç¡®æŒ‡å®šå¼‚å¸¸ç±»å‹ï¼š

```python
try:
    dt = datetime.strptime(r['timestamp'], '%Y-%m-%d %H:%M:%S')
    time_str = dt.strftime('%m-%d %H:%M')
except (ValueError, TypeError, KeyError):  # æ˜ç¡®æŒ‡å®šå¼‚å¸¸ç±»å‹
    time_str = r.get('timestamp', 'N/A')
```

---

## ğŸŸ¡ è½»å¾®é—®é¢˜ (Minor)

### 7. ç±»å˜é‡å…±äº«çŠ¶æ€é—®é¢˜

**æ–‡ä»¶**: [`components.py`](ui/components.py:16-115)  
**é—®é¢˜æè¿°**: `ModernStyle` ç±»ä½¿ç”¨ç±»å˜é‡å­˜å‚¨é¢œè‰²é…ç½®ï¼Œå¦‚æœå­˜åœ¨å¤šä¸ªåº”ç”¨å®ä¾‹ï¼Œå®ƒä»¬ä¼šå…±äº«è¿™äº›çŠ¶æ€ã€‚

```python
class ModernStyle:
    IS_DARK = False  # ç±»å˜é‡ï¼Œæ‰€æœ‰å®ä¾‹å…±äº«
    PRIMARY = "#2563EB"
    # ...
```

**å½±å“**: åœ¨å•åº”ç”¨åœºæ™¯ä¸‹æ— å½±å“ï¼Œä½†ä¸åˆ©äºæœªæ¥æ‰©å±•ï¼ˆå¦‚å¤šçª—å£ã€æµ‹è¯•éš”ç¦»ç­‰ï¼‰ã€‚

**ä¿®å¤å»ºè®®**: è€ƒè™‘æ”¹ä¸ºå®ä¾‹å˜é‡æˆ–ä½¿ç”¨é…ç½®å¯¹è±¡æ¨¡å¼ã€‚

---

### 8. âœ… å¼‚å¸¸å¤„ç†ä»…æ‰“å°ä¸è®°å½• - å·²ä¿®å¤

**æ–‡ä»¶**: [`history.py`](core/history.py:112-114)
**çŠ¶æ€**: âœ… **å·²ä¿®å¤**

**åŸé—®é¢˜æè¿°**: æ•°æ®åº“æ“ä½œçš„å¼‚å¸¸ä»…é€šè¿‡ `print` è¾“å‡ºã€‚

**ä¿®å¤æ–¹æ¡ˆ**: å·²å¼•å…¥ `logging` æ¨¡å—ï¼Œä½¿ç”¨ `logger.warning()` æ›¿ä»£ `print()`ï¼š

```python
import logging

# åˆ›å»ºæ¨¡å—çº§ logger
logger = logging.getLogger(__name__)

# ...
except Exception as e:
    logger.warning(f"Failed to save history: {e}")
    return None
```

å—å½±å“çš„æ–¹æ³•å·²å…¨éƒ¨æ›´æ–°ï¼š
- `save_record()` - ç¬¬ 112-114 è¡Œ
- `get_recent_records()` - ç¬¬ 141-143 è¡Œ
- `get_record_by_id()` - ç¬¬ 157-159 è¡Œ

---

### 9. âœ… å¯é€‰ä¾èµ–çš„ Pylance è­¦å‘Š - å·²ä¿®å¤

**æ–‡ä»¶**: [`native_app.py`](ui/native_app.py:44-48)
**çŠ¶æ€**: âœ… **å·²ä¿®å¤**

**åŸé—®é¢˜æè¿°**: `import docx` æ˜¾ç¤º Pylance è­¦å‘Šã€‚

**ä¿®å¤æ–¹æ¡ˆ**: å·²æ·»åŠ ç±»å‹å¿½ç•¥æ³¨é‡Šï¼š

```python
try:
    import docx  # type: ignore[import-untyped]
    HAS_DOCX = True
except ImportError:
    docx = None  # type: ignore[assignment]
    HAS_DOCX = False
```

---

### 10. âœ… UI ç»„ä»¶é‡å»ºå¯¼è‡´è¾“å…¥ä¸¢å¤± - å·²ä¿®å¤

**æ–‡ä»¶**: [`native_app.py`](ui/native_app.py:2499-2645)
**çŠ¶æ€**: âœ… **å·²ä¿®å¤**

**åŸé—®é¢˜æè¿°**: `_toggle_embed_api` æ–¹æ³•åœ¨åˆ‡æ¢æ—¶é”€æ¯å¹¶é‡å»ºç»„ä»¶ï¼Œå¯èƒ½å¯¼è‡´ç”¨æˆ·å·²è¾“å…¥çš„å€¼ä¸¢å¤±ã€‚

**ä¿®å¤æ–¹æ¡ˆ**: å·²åœ¨é”€æ¯å‰ä¿å­˜è¾“å…¥å€¼ï¼Œé‡å»ºåæ¢å¤ï¼š

```python
def _toggle_embed_api(self):
    # ä¿å­˜å½“å‰è¾“å…¥å€¼ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    saved_embed_base = ""
    saved_embed_key = ""
    saved_embed_model = ""
    
    if hasattr(self, 'setting_embed_base') and hasattr(self.setting_embed_base, 'winfo_exists'):
        try:
            if self.setting_embed_base.winfo_exists():
                saved_embed_base = self.setting_embed_base.get()
        except Exception:
            pass
    # ... ä¿å­˜å…¶ä»–å€¼ ...
    
    # æ¸…é™¤å¹¶é‡å»ºç»„ä»¶
    for widget in self.embed_frame.winfo_children():
        if isinstance(widget, tk.Frame):
            widget.destroy()
    
    # é‡å»ºåæ¢å¤ä¿å­˜çš„å€¼
    if saved_embed_base:
        self.setting_embed_base.insert(0, saved_embed_base)
```

---

## ğŸ’¡ ä»£ç è´¨é‡å»ºè®®

### 1. å‡½æ•°è¿‡é•¿

[`_create_settings_page`](ui/native_app.py:1939) æ–¹æ³•è¶…è¿‡ 500 è¡Œï¼Œå»ºè®®æ‹†åˆ†ä¸ºå¤šä¸ªå­æ–¹æ³•ï¼š
- `_create_llm_settings_section()`
- `_create_embed_settings_section()`  
- `_create_storage_settings_section()`
- `_create_ui_settings_section()`

### 2. é­”æ³•æ•°å­—

ä»£ç ä¸­å­˜åœ¨å¤šå¤„ç¡¬ç¼–ç æ•°å­—ï¼Œå»ºè®®æå–ä¸ºå¸¸é‡ï¼š

```python
# å½“å‰å†™æ³•
width=55, height=45

# å»ºè®®æ”¹ä¸º
ENTRY_WIDTH = 55
BUTTON_HEIGHT = 45
```

### 3. é‡å¤ä»£ç æ¨¡å¼

åˆ›å»ºè¡¨å•è¡Œçš„ä»£ç æ¨¡å¼é‡å¤å¤šæ¬¡ï¼Œå»ºè®®æå–ä¸ºé€šç”¨æ–¹æ³•ï¼š

```python
def _create_form_row(self, parent, label_text, widget_factory, **kwargs):
    row = tk.Frame(parent, bg=parent.cget("bg"))
    row.pack(fill=tk.X, pady=10)
    # ...
    return widget
```

---

## ğŸ“‹ ä¿®å¤ä¼˜å…ˆçº§å»ºè®®

| ä¼˜å…ˆçº§ | é—®é¢˜ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|------|
| P0 | #1 å˜é‡å¼•ç”¨é¡ºåºé”™è¯¯ | âœ… å·²ä¿®å¤ | åº”ç”¨ç°åœ¨å¯ä»¥æ­£å¸¸å¯åŠ¨ |
| P0 | #2 Lambda é—­åŒ…é™·é˜± | âœ… å·²ä¿®å¤ | ä½¿ç”¨é»˜è®¤å‚æ•°æ•è·å¾ªç¯å˜é‡ |
| P1 | #3 å±æ€§è®¿é—®æ—¶åºé—®é¢˜ | âœ… å·²ä¿®å¤ | æ·»åŠ äº† hasattr æ£€æŸ¥ |
| P1 | #5 ç»„ä»¶é”€æ¯åè°ƒç”¨é£é™© | âœ… å·²ä¿®å¤ | æ·»åŠ äº† winfo_exists() æ£€æŸ¥ |
| P2 | #4 pack(after=...) é—®é¢˜ | âœ… å·²ä¿®å¤ | ä½¿ç”¨æ›¿ä»£å¸ƒå±€æ–¹æ¡ˆ |
| P2 | #6 è£¸ except è¯­å¥ | âœ… å·²ä¿®å¤ | æ˜ç¡®æŒ‡å®šå¼‚å¸¸ç±»å‹ |
| P2 | #10 UI é‡å»ºè¾“å…¥ä¸¢å¤± | âœ… å·²ä¿®å¤ | ä¿å­˜è¾“å…¥å€¼å¹¶åœ¨é‡å»ºåæ¢å¤ |
| P3 | #7 ç±»å˜é‡å…±äº«çŠ¶æ€ | ğŸ’¡ å»ºè®® | å½“å‰å•åº”ç”¨åœºæ™¯æ— å½±å“ |
| P3 | #8 å¼‚å¸¸å¤„ç†ä»…æ‰“å° | âœ… å·²ä¿®å¤ | å·²ä½¿ç”¨ logging æ¨¡å— |
| P3 | #9 Pylance è­¦å‘Š | âœ… å·²ä¿®å¤ | æ·»åŠ äº† type: ignore æ³¨é‡Š |

---

## æµ‹è¯•å»ºè®®

1. ~~**å¯åŠ¨æµ‹è¯•**: éªŒè¯åº”ç”¨èƒ½å¦æ­£å¸¸å¯åŠ¨ï¼ˆæ£€éªŒé—®é¢˜ #1 æ˜¯å¦å­˜åœ¨ï¼‰~~ âœ… é—®é¢˜å·²ä¿®å¤
2. ~~**æ‰¹é‡å¤„ç†æµ‹è¯•**: é€‰æ‹©å¤šä¸ªæ–‡ä»¶è¿›è¡Œæ‰¹é‡è¯Šæ–­/ä¼˜åŒ–ï¼Œè§‚å¯Ÿè¿›åº¦æ˜¾ç¤ºï¼ˆéªŒè¯é—®é¢˜ #2ï¼‰~~ âœ… é—®é¢˜å·²ä¿®å¤
3. ~~**å¿«é€Ÿåˆ‡æ¢æµ‹è¯•**: åœ¨ AI ç”Ÿæˆè¿‡ç¨‹ä¸­é¢‘ç¹åˆ‡æ¢é¡µé¢~~ âœ… é—®é¢˜å·²ä¿®å¤
4. ~~**åå¥½æŒä¹…åŒ–æµ‹è¯•**: ä¿®æ”¹è®¾ç½®åé‡å¯åº”ç”¨ï¼ŒéªŒè¯è®¾ç½®æ˜¯å¦ä¿ç•™~~ âœ… é—®é¢˜å·²ä¿®å¤
5. ~~**åµŒå…¥é…ç½®åˆ‡æ¢æµ‹è¯•**: åœ¨åµŒå…¥æ¨¡å‹é…ç½®ä¸­åˆ‡æ¢"ä½¿ç”¨ç›¸åŒAPI"é€‰é¡¹ï¼ŒéªŒè¯è¾“å…¥å€¼ä¿ç•™~~ âœ… é—®é¢˜å·²ä¿®å¤

---

## ä¿®å¤æ—¥å¿—

### 2026-01-08 (ç¬¬äºŒæ¬¡æ›´æ–°)
- âœ… ä¿®å¤é—®é¢˜ #2: Lambda é—­åŒ…é™·é˜± - æ‰€æœ‰4å¤„ä½ç½®å‡å·²ä½¿ç”¨é»˜è®¤å‚æ•°æ•è·å¾ªç¯å˜é‡
  - `_run_diagnose` ç¬¬ 3193 è¡Œ
  - `_run_optimize` ç¬¬ 3305 è¡Œ
  - `_run_optimize_stream` ç¬¬ 3400-3403 è¡Œ
  - `_run_dedup` ç¬¬ 3475 è¡Œ
- âœ… ç¡®è®¤é—®é¢˜ #10: UI ç»„ä»¶é‡å»ºè¾“å…¥ä¸¢å¤± - å·²åœ¨ä¹‹å‰ä¿®å¤ï¼Œæ·»åŠ äº†å€¼ä¿å­˜å’Œæ¢å¤é€»è¾‘

### 2026-01-08 (é¦–æ¬¡ä¿®å¤)
- âœ… ä¿®å¤é—®é¢˜ #1: è°ƒæ•´ `_create_optimize_page` ä¸­å˜é‡åˆ›å»ºé¡ºåº
- âœ… ä¿®å¤é—®é¢˜ #3: åœ¨ `_load_ui_preferences` ä¸­æ·»åŠ  `hasattr` æ£€æŸ¥
- âœ… ä¿®å¤é—®é¢˜ #4: ä½¿ç”¨ `lift()` æ›¿ä»£ `pack(after=...)`
- âœ… ä¿®å¤é—®é¢˜ #5: åœ¨ `stream_from_generator` ä¸­æ·»åŠ  `winfo_exists()` æ£€æŸ¥
- âœ… ä¿®å¤é—®é¢˜ #6: æ˜ç¡®æŒ‡å®šå¼‚å¸¸ç±»å‹ `(ValueError, TypeError, KeyError)`
- âœ… ä¿®å¤é—®é¢˜ #8: å¼•å…¥ `logging` æ¨¡å—æ›¿ä»£ `print` è¯­å¥
- âœ… ä¿®å¤é—®é¢˜ #9: æ·»åŠ  `type: ignore` æ³¨é‡Šæ¶ˆé™¤ Pylance è­¦å‘Š

---

*æŠ¥å‘Šç”Ÿæˆæ—¶é—´: 2026-01-08*
*æœ€åæ›´æ–°: 2026-01-08 18:05*