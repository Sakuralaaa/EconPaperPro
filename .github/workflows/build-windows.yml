# GitHub Actions å·¥ä½œæµ - Windows æ‰“åŒ…
# è‡ªåŠ¨æ„å»º EconPaper Pro Windows å¯æ‰§è¡Œæ–‡ä»¶

name: Build Windows Application

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ä»¥ v å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘ï¼ˆå¦‚ v1.0.0ï¼‰
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (å¦‚ 1.0.0)'
        required: true
        default: '1.0.0'

env:
  PYTHON_VERSION: '3.11'
  APP_NAME: 'EconPaperPro'

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      # 2. è®¾ç½® Python ç¯å¢ƒ
      - name: è®¾ç½® Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      # 3. è·å–ç‰ˆæœ¬å·
      - name: è·å–ç‰ˆæœ¬å·
        id: get_version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "æ„å»ºç‰ˆæœ¬: $VERSION"
      
      # 4. å®‰è£…ä¾èµ–
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
      
      # 5. åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
      - name: åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯
        shell: python
        run: |
          version = "${{ steps.get_version.outputs.VERSION }}"
          parts = version.split('.')
          major = int(parts[0]) if len(parts) > 0 else 1
          minor = int(parts[1]) if len(parts) > 1 else 0
          patch = int(parts[2]) if len(parts) > 2 else 0
          
          version_info = f'''
          VSVersionInfo(
            ffi=FixedFileInfo(
              filevers=({major}, {minor}, {patch}, 0),
              prodvers=({major}, {minor}, {patch}, 0),
              mask=0x3f,
              flags=0x0,
              OS=0x40004,
              fileType=0x1,
              subtype=0x0,
              date=(0, 0)
            ),
            kids=[
              StringFileInfo(
                [
                  StringTable(
                    '080404b0',
                    [
                      StringStruct('CompanyName', 'EconPaper'),
                      StringStruct('FileDescription', 'EconPaper Pro - ç»ç®¡å­¦æœ¯è®ºæ–‡æ™ºèƒ½ä¼˜åŒ–ç³»ç»Ÿ'),
                      StringStruct('FileVersion', '{version}'),
                      StringStruct('InternalName', 'EconPaperPro'),
                      StringStruct('LegalCopyright', 'Copyright Â© 2024'),
                      StringStruct('OriginalFilename', 'EconPaperPro.exe'),
                      StringStruct('ProductName', 'EconPaper Pro'),
                      StringStruct('ProductVersion', '{version}')
                    ]
                  )
                ]
              ),
              VarFileInfo([VarStruct('Translation', [2052, 1200])])
            ]
          )
          '''
          
          with open('version_info.txt', 'w', encoding='utf-8') as f:
              f.write(version_info)
          
          print(f"ç‰ˆæœ¬ä¿¡æ¯å·²ç”Ÿæˆ: {version}")
      
      # 6. è¿è¡Œ PyInstaller æ‰“åŒ…
      - name: æ‰“åŒ…åº”ç”¨
        run: |
          pyinstaller --clean econpaper.spec
      
      # 7. åˆ›å»ºå‘å¸ƒåŒ…
      - name: åˆ›å»ºå‘å¸ƒåŒ…
        shell: bash
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          RELEASE_NAME="${{ env.APP_NAME }}-v${VERSION}-windows-x64"
          
          # åˆ›å»ºå‘å¸ƒç›®å½•
          mkdir -p "release/${RELEASE_NAME}"
          
          # å¤åˆ¶æ‰“åŒ…æ–‡ä»¶
          cp -r dist/EconPaperPro/* "release/${RELEASE_NAME}/"
          
          # å¤åˆ¶é…ç½®æ–‡ä»¶æ¨¡æ¿
          if [ -f ".env.example" ]; then
            cp .env.example "release/${RELEASE_NAME}/.env.example"
          fi
          
          # å¤åˆ¶è¯´æ˜æ–‡æ¡£
          if [ -f "README.md" ]; then
            cp README.md "release/${RELEASE_NAME}/"
          fi
          
          # åˆ›å»ºå¿«é€Ÿå¯åŠ¨è„šæœ¬
          echo '@echo off
          echo Starting EconPaper Pro...
          start "" "%~dp0EconPaperPro.exe"
          ' > "release/${RELEASE_NAME}/å¯åŠ¨.bat"
          
          # å‹ç¼©
          cd release
          7z a -tzip "${RELEASE_NAME}.zip" "${RELEASE_NAME}"
          
          echo "å‘å¸ƒåŒ…å·²åˆ›å»º: ${RELEASE_NAME}.zip"
      
      # 8. ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-v${{ steps.get_version.outputs.VERSION }}-windows-x64
          path: release/*.zip
          retention-days: 30
      
      # 9. åˆ›å»º GitHub Releaseï¼ˆä»…å½“æ¨é€æ ‡ç­¾æ—¶ï¼‰
      - name: åˆ›å»º GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          name: EconPaper Pro v${{ steps.get_version.outputs.VERSION }}
          body: |
            ## EconPaper Pro v${{ steps.get_version.outputs.VERSION }}
            
            ### ğŸ“¦ ä¸‹è½½è¯´æ˜
            1. ä¸‹è½½ `EconPaperPro-v${{ steps.get_version.outputs.VERSION }}-windows-x64.zip`
            2. è§£å‹åˆ°ä»»æ„ç›®å½•
            3. åŒå‡» `å¯åŠ¨.bat` æˆ– `EconPaperPro.exe` è¿è¡Œ
            
            ### âš™ï¸ é¦–æ¬¡ä½¿ç”¨
            1. é¦–æ¬¡è¿è¡Œæ—¶ä¼šå¼¹å‡ºè®¾ç½®å‘å¯¼
            2. é€‰æ‹©æ•°æ®å­˜å‚¨ç›®å½•å’Œå·¥ä½œåŒºç›®å½•
            3. åœ¨åº”ç”¨ä¸­é…ç½® API Key
            
            ### ğŸ“ æ›´æ–°æ—¥å¿—
            - æŸ¥çœ‹ CHANGELOG.md äº†è§£è¯¦ç»†æ›´æ–°å†…å®¹
          files: |
            release/*.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # å¯é€‰ï¼šæ„å»ºä¾¿æºç‰ˆï¼ˆå•æ–‡ä»¶ï¼‰
  build-portable:
    runs-on: windows-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: è·å–ç‰ˆæœ¬å·
        id: get_version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
      
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
      
      - name: æ‰“åŒ…å•æ–‡ä»¶ç‰ˆæœ¬
        run: |
          pyinstaller --onefile --name EconPaperPro-Portable --console main.py
      
      - name: ä¸Šä¼ ä¾¿æºç‰ˆ
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-v${{ steps.get_version.outputs.VERSION }}-portable
          path: dist/EconPaperPro-Portable.exe
          retention-days: 30
